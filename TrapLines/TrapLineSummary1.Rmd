---
title: "Maruia Trap-lines: Monthly Summary"
author: "Peter Alspach"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    pdf_document:
  # html_document:
  # html_notebook:
    theme: spacelab
    toc: yes
    toc_depth: 5
    # toc_float: yes
    # code_folding: hide
---

<!-- To do: -->
<!-- Mammals are defined at the end of the 'getReady' chunk (about line 58) -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, cache=FALSE, error=TRUE)
library(knitr)
library(kableExtra)
```
## Introduction

```{r readData}
# Set the working directory and read the data
setwd('~/GitHub/SpringsJunction/TrapLines')
tl <- read.csv('TrapCatches.csv', header=TRUE, sep=',', stringsAsFactors=FALSE)

# Rename traps with only a single digit 'd' to '0d'
relNo <- tl[grep('[[:upper:]][[:digit:]]{1}$', tl$Tag.No), 'Tag.No']
relNo <- paste0(substring(relNo, 1, nchar(relNo)-1), '0', substring(relNo, nchar(relNo)))
tl[grep('[[:upper:]][[:digit:]]{1}$', tl$Tag.No), 'Tag.No'] <- relNo

# Remove time from date stamp
tl$Date.Checked <- substring(tl$Date.Checked, 1, 10)
yr <- as.integer(substring(tl[substring(tl$Date.Checked, 4)>='01-16', 'Date.Checked'][1], 1, 4))
tl$jDay <- julian.Date(as.Date(tl$Date.Checked), origin=as.Date(paste0(yr-1, '-12-31')))
tlOld <- tl[tl$jDay <= 15,]
tl <- tl[tl$jDay > 15,]

# # Line name and code
# ttTab <- table(tl$Line, gsub('([[:upper:]]+)([[:digit:]]+)', '\\1', tl$Tag.No))
# apply(ttTab, 1, function(x) dimnames(ttTab)[[2]][x!=0])
```

```{r getReady}
# Set the cut-off dates for the monthly intervals
lastDate <- sort(tl$Date.Checked, decreasing=TRUE)[1]
mth <- as.integer(substring(lastDate, 6, 7))
cutDays <- paste(yr, c(paste0('0', 1:9), 10:12), '15', sep='-') # cut at the middle of the month 
cutDays <- julian.Date(as.Date(cutDays), origin=as.Date(paste0(yr-1, '-12-31')))
mthInt <- c('J-F', 'F-M', 'M-A','A-M', 'M-J', 'J-J','J-A', 'A-S', 'S-O', 'O-N', 'N-D', 'D-J')
obsMth <- cut(tl$jDay, c(cutDays, 365+15+floor((4.001-yr%%4)/4)), labels=mthInt)

# Set the standard trap status of interest
stdStat <- c('Sprung and Empty','Rat','Stoat','Weasel') # standard trap status
allMammals <- c('Rat','Stoat','Weasel','Cat','Ferret','Mouse','Rabbit','Hedgehog','Hare','Possum')
```

```{r readDataPY}
# Read the data for the previous year
tlPY <- read.csv(paste0('TrapCatches', yr-1, '.csv'), header=TRUE, sep=',', stringsAsFactors=FALSE)

# Rename traps with only a single digit 'd' to '0d'
relNoPY <- tlPY[grep('[[:upper:]][[:digit:]]{1}$', tlPY$Tag.No), 'Tag.No']
relNoPY <- paste0(substring(relNoPY, 1, nchar(relNoPY)-1), '0', substring(relNoPY, nchar(relNoPY)))
tlPY[grep('[[:upper:]][[:digit:]]{1}$', tlPY$Tag.No), 'Tag.No'] <- relNoPY

# Remove time from date stamp
tlPY$Date.Checked <- substring(tlPY$Date.Checked, 1, 10)
tlPY$jDay <- julian.Date(as.Date(tlPY$Date.Checked), origin=as.Date(paste0(yr-2, '-12-31')))

obsMthPY <- cut(tlPY$jDay, c(cutDays, 365+15+floor((4.001-(yr-1)%%4)/4)), labels=mthInt)
```

The following tables give a summary of the catches from the `r length(unique(tl$Tag.No))` trap boxes^[On some lines (Maruia River, Kellys, and parts of Fergusons Flat) each box contains two traps.  Thus, on these lines it is possible to catch two mammals per trap box.] on the `r length(unique(tl$Line))` trap-lines at Maruia.  The intention is to check the traps monthly around the change of the month, hence monthly summaries are aggregated from the 16^th^ of one month to the 15^th^ of the next (and labelled with the first letter of the two months)

The summary is for the most recent monthly interval (`r paste(month.name[(mth-1):mth], collapse='-')`) in `r yr` and also the entire year-to-date.

## The most recent monthly interval

```{r currMth}
# Subset tl to the data for the current month only
if (mth==1) mth <- 13
# obsMthOld <- obsMth[as.integer(substring(tl$Date.Checked, 1, 4)) < yr]
# obsMth <- obsMth[as.integer(substring(tl$Date.Checked, 1, 4)) == yr]
# tlOld <- tl[as.integer(substring(tl$Date.Checked, 1, 4)) < yr,]
# tl <- tl[as.integer(substring(tl$Date.Checked, 1, 4)) == yr,]
currMth <- tl[obsMth==levels(obsMth)[mth-1],]

# First tabulate the number of pests caught
trap1 <- table(currMth$Line, currMth$Trap.1)
trap2 <- table(currMth$Line, currMth$Trap.2)
# trap2 <- trap2[, colnames(trap2)!='N/A']
tt <- unique(c(colnames(trap1), colnames(trap2)))
tt <- tt[tt!='N/A']

trap1 <- cbind(trap1, matrix(0, nrow(trap1), sum(!(tt %in% colnames(trap1))),
                             dimnames=list(dimnames(trap1)[[1]], tt[!(tt %in% colnames(trap1))])))
trap2 <- cbind(trap2, matrix(0, nrow(trap2), sum(!(tt %in% colnames(trap2))),
                             dimnames=list(dimnames(trap2)[[1]], tt[!(tt %in% colnames(trap2))])))
trap2 <- trap2[, colnames(trap2)!='N/A']
catch <- trap1[, tt] + trap2[, tt]
# catch <- catch[, match(c(stdStat, 'Cat','Ferret','Mouse','Rabbit'), colnames(catch))]
catch <- catch[, match(unique(c(stdStat, allMammals)), colnames(catch))]
catch <- cbind(catch[, 1:length(stdStat)],
               Other=apply(catch[, -(1:length(stdStat))], 1, sum, na.rm=TRUE))
catch <- cbind(catch, Total=apply(catch[, -1], 1, sum, na.rm=TRUE))

# Next add in the number of traps per line (irrespective of whether some are missing)
nTrap <- table(tl$Line, gsub('([[:upper:]]+)([[:digit:]]+)', '\\2', tl$Tag.No))
nTrap <- apply(nTrap, 1, function(x) length(x[x!=0]))
catch <- merge(nTrap, catch, by='row.names', all=TRUE)
colnames(catch)[2:3] <- c('nTrap','Sprung')

rownames(catch) <- catch$Row.names
catch <- catch[,-1]
catch <- rbind(catch, apply(catch, 2, sum, na.rm=TRUE))
rownames(catch)[nrow(catch)] <- 'TOTAL'

# Add proportions based on total number of traps per line (including missing traps)
catch <- cbind(catch, round(apply(catch[,-1], 2, function(x) 100*x/catch[,1]), 1))
catch[nrow(catch), ncol(catch)] <- round(100*catch[nrow(catch), 'Total']/
  sum(catch[-nrow(catch), 'nTrap'][!is.na(catch[,'Total'])], na.rm=TRUE), 1)
```

Table \ref{currMthN} (below) summarises the number of mammals caught in the most recent monthly interval for each line.  The first column is the number of trap boxes^[In some cases trap boxes may be missing or not found at checking, but this is disregarded in this summary], followed by the number of traps which were sprung but empty.  The remaining columns (in blue) give the catch of rats, stoats, weasels, other mammals (e.g., cats, ferrets, rabbits) and the total mammals.  

```{r currMthN}
# kable(catch[, 1:(length(stdStat)+3)]) %>%
#   kable_styling(full_width=FALSE) %>%
kable(catch[, 1:(length(stdStat)+3)], 'latex', booktabs=TRUE,
      caption="\\label{currMthN}Current month's catch for each line.") %>%
  kable_styling(latex_options="hold_position") %>%
  column_spec(length(stdStat)+4, bold=TRUE, color='blue') %>%
  column_spec(2, color='gray') %>%
  column_spec(4:7, color='blue') %>%
  row_spec(nrow(catch), bold=TRUE, background="#e5e5e5")
```

\pagebreak

The next table (Table \ref{currMthPC}) is similar, except that the numbers are expressed as percentages of the total number of trap boxess on the line.

```{r currMthPC}
# kable(catch[, c(1, ((length(stdStat)+4):ncol(catch)))]) %>%
#   kable_styling(full_width=FALSE) %>%
kable(catch[, c(1, ((length(stdStat)+4):ncol(catch)))], 'latex', booktabs=TRUE,
      caption="\\label{currMthPC}Current month's catch per trap box ($\\times$ 100) for each line.") %>%
  kable_styling(latex_options="hold_position") %>%
  column_spec(length(stdStat)+4, bold=TRUE, color='blue') %>%
  column_spec(2, color='gray') %>%
  column_spec(4:7, color='blue') %>%
  row_spec(nrow(catch), bold = T, background = "#e5e5e5")
```

## The year to date

### Mammals caught by line

```{r yrToDate}
# First tabulate the number of pests caught
trap1 <- table(tl$Line, tl$Trap.1)
trap2 <- table(tl$Line, tl$Trap.2)
trap2 <- trap2[, colnames(trap2)!='N/A']
tt <- unique(c(colnames(trap1), colnames(trap2)))

trap1 <- cbind(trap1, matrix(0, nrow(trap1), sum(!(tt %in% colnames(trap1))),
                             dimnames=list(dimnames(trap1)[[1]], tt[!(tt %in% colnames(trap1))])))
trap2 <- cbind(trap2, matrix(0, nrow(trap2), sum(!(tt %in% colnames(trap2))),
                             dimnames=list(dimnames(trap2)[[1]], tt[!(tt %in% colnames(trap2))])))
catch <- trap1[, tt] + trap2[, tt]
catch <- catch[, match(unique(c(stdStat, allMammals)), colnames(catch))]
catch <- cbind(catch[, 1:length(stdStat)],
               Other=apply(catch[, -(1:length(stdStat))], 1, sum, na.rm=TRUE))
catch <- cbind(catch, Total=apply(catch[, -1], 1, sum, na.rm=TRUE))

# Next add in the number of traps per line (irrespective of whether some are missing)
catch <- merge(nTrap, catch, by='row.names', all=TRUE) # nTrap previously calculated
colnames(catch)[2:3] <- c('nTrap','Sprung')

rownames(catch) <- catch$Row.names
catch <- catch[,-1]
catch <- rbind(catch, apply(catch, 2, sum, na.rm=TRUE))
rownames(catch)[nrow(catch)] <- 'TOTAL'

# Add numbers caught per trap per month (x 100)
catch <- cbind(catch, round(apply(catch[,-1], 2, function(x) 100*x/(catch[,1]*(mth-1))), 1))
```

Table \ref{yrToDateN} (below) summarises the number of mammals caught in the year to date for each line.  The first column is the number of trap boxes, followed by the number of traps which were sprung but empty.  The remaining columns (in blue) give the catch of rats, stoats, weasels, other mammals (e.g., cats, ferrets, rabbits) and the total mammals.  

```{r yrToDateN, echo=FALSE}
# kable(catch[, 1:(length(stdStat)+3)]) %>%
#   kable_styling(full_width=FALSE) %>%
kable(catch[, 1:(length(stdStat)+3)], 'latex', booktabs=TRUE,
      caption='\\label{yrToDateN}Total year-to-date catch for each line.') %>%
  kable_styling(latex_options="hold_position") %>%
  column_spec(length(stdStat)+4, bold=TRUE, color='blue') %>%
  column_spec(2, color='gray') %>%
  column_spec(4:7, color='blue') %>%
  row_spec(nrow(catch), bold = T, background = "#e5e5e5")
```

\pagebreak

Next, the data are presented as numbers caught per trap box per month ($\times$ 100) for each line (Table \ref{yrToDatePC}).  This is analogous to the second table in the current month section which gave the percentages.

```{r yrToDatePC}
# kable(catch[, c(1, ((length(stdStat)+4):ncol(catch)))]) %>%
  # kable_styling(full_width=FALSE) %>%
kable(catch[, c(1, ((length(stdStat)+4):ncol(catch)))], 'latex', booktabs=TRUE,
      caption='\\label{yrToDatePC}Year-to-date catch per trap box per month ($\\times$ 100) for each line.') %>%
  kable_styling(latex_options="hold_position") %>%
  column_spec(length(stdStat)+4, bold=TRUE, color='blue') %>%
  column_spec(2, color='gray') %>%
  column_spec(4:7, color='blue') %>%
  row_spec(nrow(catch), bold = T, background = "#e5e5e5")
```

\pagebreak

### Mammals caught by month

```{r mthCatchP}
# First tabulate the number of pests caught
trap1 <- table(obsMth, tl$Trap.1)
trap2 <- table(obsMth, tl$Trap.2)
trap2 <- trap2[, colnames(trap2)!='N/A']
tt <- unique(c(colnames(trap1), colnames(trap2)))

trap1 <- cbind(trap1, matrix(0, nrow(trap1), sum(!(tt %in% colnames(trap1))),
                             dimnames=list(dimnames(trap1)[[1]], tt[!(tt %in% colnames(trap1))])))
trap2 <- cbind(trap2, matrix(0, nrow(trap2), sum(!(tt %in% colnames(trap2))),
                             dimnames=list(dimnames(trap2)[[1]], tt[!(tt %in% colnames(trap2))])))
catch <- trap1[, tt] + trap2[, tt]
catch <- catch[, match(unique(c(stdStat, allMammals)), colnames(catch))]
catch <- cbind(catch[, 1:length(stdStat)],
               Other=apply(catch[, -(1:length(stdStat))], 1, sum, na.rm=TRUE))
catch <- cbind(catch, Total=apply(catch[, -1], 1, sum, na.rm=TRUE))

# Next add in the number of traps per line (irrespective of whether some are missing)
colnames(catch)[1] <- 'Sprung'

# Add numbers caught per trap per month (x 100)
catch <- cbind(catch, round(apply(catch[,-1], 2, function(x) 100*x/(catch[,1]*(mth-1))), 1))

# Ditto for the previous year
trap1PY <- table(obsMthPY, tlPY$Trap.1)
trap2PY <- table(obsMthPY, tlPY$Trap.2)
trap2PY <- trap2PY[, colnames(trap2PY)!='N/A']
tt <- unique(c(colnames(trap1PY), colnames(trap2PY)))

trap1PY <- cbind(trap1PY, matrix(0, nrow(trap1PY), sum(!(tt %in% colnames(trap1PY))),
                                 dimnames=list(dimnames(trap1PY)[[1]],
                                               tt[!(tt %in% colnames(trap1PY))])))
trap2PY <- cbind(trap2PY, matrix(0, nrow(trap2PY), sum(!(tt %in% colnames(trap2PY))),
                                 dimnames=list(dimnames(trap2PY)[[1]],
                                               tt[!(tt %in% colnames(trap2PY))])))
catchPY <- trap1PY[, tt] + trap2PY[, tt]
catchPY <- catchPY[, match(unique(c(stdStat, allMammals)), colnames(catchPY))]
catchPY <- cbind(catchPY[, 1:length(stdStat)],
               Other=apply(catchPY[, -(1:length(stdStat))], 1, sum, na.rm=TRUE))
catchPY <- cbind(catchPY, Total=apply(catchPY[, -1], 1, sum, na.rm=TRUE))

# Next add in the number of traps per line (irrespective of whether some are missing)
colnames(catchPY)[1] <- 'Sprung'

# Add numbers caught per trap per month (x 100)
catchPY <- cbind(catchPY, round(apply(catchPY[,-1], 2,
                                      function(x) 100*x/(catchPY[,1]*(mth-1))), 1))
```

Figure \ref{mthCatchPFig} shows the catch per month summed over all lines for all mammals (total), rats, mustelids (stoats and weasels) and other mammals (including ferrets).  The figure includes the previous year's results for comparison.

```{r, mthCatchPFig, fig.height=4, fig.cap="\\label{mthCatchPFig}Trap catches summed over all lines for each monthly interval. Previous year represented by dashed lines with the same colour coding.  Note: 'mustelid' includes only stoats and weasels (ferrets are included in 'other')."}
par(mar=c(3,3,0.5,2), las=1, mgp=c(2.2, 0.8, 0), xpd=TRUE)
tt <- catch[catch[,'Total']!=0,]
ttPY <- catchPY
ttPY[ttPY[,'Total']==0,] <- NA
yLim <- c(0, max(c(tt[,'Total'], ttPY[,'Total']), na.rm=TRUE))
plot(1:nrow(tt), tt[,'Total'], xlab='Month interval', ylab='Numbers caught',
     xlim=c(1,12), ylim=yLim, xaxt='n', type='l', bty='n')
axis(1, 1:nrow(ttPY), row.names(ttPY))
axis(2, yLim, c('',''), tck=0)            
lines(1:nrow(tt), tt[,'Rat'], col='gray40')
lines(1:nrow(tt), tt[,'Stoat']+tt[,'Weasel'], col='brown')
lines(1:nrow(tt), tt[,'Other'], col='orange')

# Previous year
lines(1:nrow(ttPY), ttPY[,'Total'], lty='dashed')
lines(1:nrow(ttPY), ttPY[,'Rat'], col='gray40', lty='dashed')
lines(1:nrow(ttPY), ttPY[,'Stoat']+ttPY[,'Weasel'], col='brown', lty='dashed')
lines(1:nrow(ttPY), ttPY[,'Other'], col='orange', lty='dashed')

text(rep(nrow(tt)+0.1, 4), c(tt[nrow(tt),c('Total','Rat')]+c(2,-2),
                             tt[nrow(tt),'Stoat']+tt[nrow(tt),'Weasel']+2, tt[nrow(tt),'Other']-2),
     c('Total','Rat','Mustelid','Other'), adj=0, xpd=TRUE, cex=0.8,
     col=c('black','gray40','brown','orange'))
```

\pagebreak

### Catch by month for each line

```{r mthCatchL}
# First tabulate the number of pests caught
trap1 <- table(obsMth, tl$Line, tl$Trap.1)
# trap1 <- apply(trap1[,, c('Rat','Stoat','Weasel','Cat','Ferret','Mouse','Rabbit')], 1:2, sum)
trap2 <- table(obsMth, tl$Line, tl$Trap.2)
# trap2 <- apply(trap2[,, c('Rat','Stoat','Weasel','Cat','Ferret','Mouse','Rabbit')], 1:2, sum)
trap2 <- trap2[, , dimnames(trap2)[[3]]!='N/A']
tt <- unique(c(dimnames(trap1)[[3]], dimnames(trap2)[[3]]))
# Append to trap1 if necessary
appd <- array(0, replace(dim(trap1), 3, length(tt)-dim(trap1)[3]),
              dimnames=list(dimnames(trap1)[[1]], dimnames(trap1)[[2]],
                            tt[!(tt %in% dimnames(trap1)[[3]])]))
trap1 <- abind::abind(trap1, appd, along=3)
# Append to trap2
appd <- array(0, replace(dim(trap2), 3, length(tt)-dim(trap2)[3]),
              dimnames=list(dimnames(trap2)[[1]], dimnames(trap2)[[2]],
                            tt[!(tt %in% dimnames(trap2)[[3]])]))
trap2 <- abind::abind(trap2, appd, along=3)
# Only interested in mammalian catch
mammals <- allMammals[allMammals %in% dimnames(trap1)[[3]]]
trap1 <- apply(trap1[,, mammals], 1:2, sum)
trap2 <- apply(trap2[,, mammals], 1:2, sum)

catch <- trap1 + trap2
catch[table(obsMth, tl$Line)==0] <- NA # put missing value in where line not checked
catch <- catch[apply(catch, 1, function(x) length(x[!is.na(x)]))!=0,] # remove unchecked months
catch <- 100*catch/matrix(nTrap, nrow(catch), ncol(catch), byrow=TRUE) # per trap

# Previous year
trap1PY <- table(obsMthPY, tlPY$Line, tlPY$Trap.1)
trap2PY <- table(obsMthPY, tlPY$Line, tlPY$Trap.2)

trap2PY <- trap2PY[, , dimnames(trap2PY)[[3]]!='N/A']
tt <- unique(c(dimnames(trap1PY)[[3]], dimnames(trap2PY)[[3]]))

appd <- array(0, replace(dim(trap1PY), 3, length(tt)-dim(trap1PY)[3]),
              dimnames=list(dimnames(trap1PY)[[1]], dimnames(trap1PY)[[2]],
                            tt[!(tt %in% dimnames(trap1PY)[[3]])]))
trap1PY <- abind::abind(trap1PY, appd, along=3)

appd <- array(0, replace(dim(trap2PY), 3, length(tt)-dim(trap2PY)[3]),
              dimnames=list(dimnames(trap2PY)[[1]], dimnames(trap2PY)[[2]],
                            tt[!(tt %in% dimnames(trap2PY)[[3]])]))
trap2PY <- abind::abind(trap2PY, appd, along=3)

mammals <- allMammals[allMammals %in% dimnames(trap1PY)[[3]]]
trap1PY <- apply(trap1PY[,, mammals], 1:2, sum)
trap2PY <- apply(trap2PY[,, mammals], 1:2, sum)

catchPY <- trap1PY + trap2PY
catchPY[table(obsMthPY, tlPY$Line)==0] <- NA # put missing value in where line not checked
catchPY <- catchPY[apply(catchPY, 1, function(x) length(x[!is.na(x)]))!=0,] # remove unchecked months
catchPY <- 100*catchPY/matrix(nTrap, nrow(catchPY), ncol(catchPY), byrow=TRUE) # per trap
catchPY <- merge(as.data.frame(mthInt), catchPY, by.x='mthInt', by.y='row.names', all.x=TRUE)
rownames(catchPY) <- catchPY[,1]
catchPY <- as.matrix(catchPY[mthInt, -1])
```

Figure \ref{mthCatchLFig} shows the monthly catch per trap box ($\times$ 100) of all mammals for half of the lines on the top and for the other half on the bottom.  The colours have been chosen to roughly match those on the map supplied by DoC, and the line names have been abbreviated.  The previous year's results are also shown for comparison (although it is not always easy to distinguish the colours).

```{r, mthCatchLFig, fig.height=6.3, fig.cap="\\label{mthCatchLFig}Monthly trap catch per trap ($\\times$ 100) of all mammals for each line. Some lines were not checked in some monthly periods, which is indicated by the disconnected lines. Previous year represented by dashed lines with the same colour coding. Note: the vertical scale on the two figures may differ."}
par(mar=c(3,3,0,2.5), las=1, mgp=c(2.2, 0.8, 0), mfrow=c(2,1))
tt <- catch[, colnames(catch) %in% c('Lewis Pass H/Way','Lockingtons','Marble Hill',
                                     'Maruia River','Kellys','Campground')]
ttPY <- catchPY[, colnames(catchPY) %in% c('Lewis Pass H/Way','Lockingtons','Marble Hill',
                                     'Maruia River','Kellys','Campground')]
lCol <- c('gold','darkgreen','grey40','turquoise','lightgreen','pink3')
yLim <- c(0, max(c(tt, ttPY), na.rm=TRUE))
plot(1:nrow(tt), tt[,1], xlab='Month interval', ylab='Catch per trap (x100)',
     xlim=c(1,12), ylim=yLim, xaxt='n', type='l', bty='n')
axis(1, 1:12, mthInt)
axis(2, yLim, c('',''), tck=0)

for(i in 1:ncol(tt))
{
  lines(1:nrow(ttPY), ttPY[,i], col=lCol[i], lty='dashed')
  points(1:nrow(ttPY), ttPY[,i], col=lCol[i], cex=0.5)
  lines(1:nrow(tt), tt[,i], col=lCol[i])
  points(1:nrow(tt), tt[,i], col=lCol[i], pch=16, cex=0.5)
  text(nrow(tt)+0.1, tt[nrow(tt), i], abbreviate(colnames(tt), 6)[i],
       adj=0, xpd=TRUE, cex=0.8, col=lCol[i])
}

tt <- catch[, !(colnames(catch) %in% c('Lewis Pass H/Way','Lockingtons','Marble Hill',
                                       'Maruia River','Kellys','Campground'))]
ttPY <- catchPY[, !(colnames(catchPY) %in% c('Lewis Pass H/Way','Lockingtons','Marble Hill',
                                       'Maruia River','Kellys','Campground'))]
lCol <- c('darkred','pink3','grey40','blue','red','green')
yLim <- c(0, max(c(tt, ttPY), na.rm=TRUE))
plot(1:nrow(tt), tt[,1], xlab='Month interval', ylab='Catch per trap (x100)',
     xlim=c(1,12), ylim=yLim, xaxt='n', type='l', bty='n')
axis(1, 1:12, mthInt)
axis(2, yLim, c('',''), tck=0)

for(i in 1:ncol(tt))
{
  lines(1:nrow(ttPY), ttPY[,i], col=lCol[i], lty='dashed')
  points(1:nrow(ttPY), ttPY[,i], col=lCol[i], cex=0.5)
  lines(1:nrow(tt), tt[,i], col=lCol[i])
  points(1:nrow(tt), tt[,i], col=lCol[i], pch=16, cex=0.5)
  text(nrow(tt)+0.1, tt[nrow(tt), i], abbreviate(colnames(tt), 6)[i],
       adj=0, xpd=TRUE, cex=0.8, col=lCol[i])
}
```

## Miscellaneous species

```{r, miscSpp}
mSppFn <- function(sppTab, spp, sppPlural, zero=TRUE)
{
  if (spp %in% names(sppTab))
  {
    if (sppTab[names(sppTab)==spp]==1) paste(1, tolower(spp)) else
        paste(sppTab[names(sppTab)==spp], sppPlural)
  } else
  {
    if (zero) paste(0, sppPlural) else NULL
  }
}

miscSppY <- table(unlist(tl[, c('Trap.1','Trap.2')]))
miscSppM <- table(unlist(currMth[, c('Trap.1','Trap.2')]))
```

### Other mammals

The other mammals (i.e., 'Other' in the tables and figures above) caught so far this year are:
`r mSppFn(miscSppY, 'Cat', 'cats')`,
`r mSppFn(miscSppY, 'Ferret', 'ferrets')`,
`r mSppFn(miscSppY, 'Hedgehog', 'hedgehogs')`,
`r mSppFn(miscSppY, 'Mouse', 'mice')`, and
`r mSppFn(miscSppY, 'Rabbit', 'rabbits')`.
Of these, `r if ('Cat' %in% names (miscSppM)) paste0(mSppFn(miscSppM, 'Cat', 'cats', zero=FALSE), ',')` `r if ('Ferret' %in% names (miscSppM)) paste0(mSppFn(miscSppM, 'Ferret', 'ferrets', zero=FALSE), ',')` `r if ('Hedgehog' %in% names (miscSppM)) paste0(mSppFn(miscSppM, 'Hedgehog', 'hedgehogs', zero=FALSE), ',')` `r if ('Mouse' %in% names (miscSppM)) paste0(mSppFn(miscSppM, 'Mouse', 'mice', zero=FALSE), ',')` `r if ('Rabbit' %in% names (miscSppM)) paste0(mSppFn(miscSppM, 'Rabbit', 'rabbits', zero=FALSE), ',')` was/were caught in the current monthly period.

### Non-target species

Finally, in the year to date, the following non-target species have been caught: 
`r mSppFn(miscSppY, 'Harrier', 'harrier')`,
`r mSppFn(miscSppY, 'Robin', 'robins')`, 
`r mSppFn(miscSppY, 'Weka', 'weka')`. and
`r mSppFn(miscSppY, 'Weka Juvenile', 'weka juveniles')`.

```{r OtherSeeComment}
osc <- tl[tl$Trap.1=='Other see comment' | tl$Trap.2=='Other see comment',]
osc <- osc[osc$Record.Comment!='' & osc$Status=='Open',]
```
Other non-target species caught in the year to date are `r osc$Record.Comment`.
\color{black!50}

### Check

Here are the contents of \texttt{miscSppY} and \texttt{miscSppM} as a check that nothing has been missed from the two previous sub-sections:

```{r miscSppChk}
chkTab <- merge(cbind(Spp=names(miscSppY), ToDate=miscSppY),
                cbind(Spp=names(miscSppM), Month=miscSppM), all=TRUE)
excl <- c('N/A','Other see comment','Rat','Sprung and Empty','Still Set',
          'Still Set Bait Eaten','Stoat','Weasel')
chkTab <- chkTab[!(chkTab[,'Spp'] %in% excl),]
row.names(chkTab) <- NULL
kable(chkTab, 'latex', booktabs=TRUE) %>%
  kable_styling(latex_options="hold_position") %>%
  column_spec(1:3, color='gray')
```

```{r mthCatchT}
# Get monthly catch summary for each trap
# First tabulate the number of pests caught
trap1 <- table(obsMth, tl$Tag.No, tl$Trap.1)
# trap1 <- apply(trap1[,, c('Rat','Stoat','Weasel','Cat','Ferret','Mouse','Rabbit')], 1:2, sum)
trap2 <- table(obsMth, tl$Tag.No, tl$Trap.2)
# trap2 <- apply(trap2[,, c('Rat','Stoat','Weasel','Cat','Ferret','Mouse','Rabbit')], 1:2, sum)
trap2 <- trap2[, , dimnames(trap2)[[3]]!='N/A']
tt <- unique(c(dimnames(trap1)[[3]], dimnames(trap2)[[3]]))
# Append to trap1 if necessary
appd <- array(0, replace(dim(trap1), 3, length(tt)-dim(trap1)[3]),
              dimnames=list(dimnames(trap1)[[1]], dimnames(trap1)[[2]],
                            tt[!(tt %in% dimnames(trap1)[[3]])]))
trap1 <- abind::abind(trap1, appd, along=3)
# Append to trap2
appd <- array(0, replace(dim(trap2), 3, length(tt)-dim(trap2)[3]),
              dimnames=list(dimnames(trap2)[[1]], dimnames(trap2)[[2]],
                            tt[!(tt %in% dimnames(trap2)[[3]])]))
trap2 <- abind::abind(trap2, appd, along=3)
# Only interested in mammalian catch
mammals <- allMammals[allMammals %in% dimnames(trap1)[[3]]]
trap1 <- apply(trap1[,, mammals], 1:2, sum)
trap2 <- apply(trap2[,, mammals], 1:2, sum)

catch <- trap1 + trap2

# Previous year
trap1PY <- table(obsMthPY, tlPY$Tag.No, tlPY$Trap.1)
trap2PY <- table(obsMthPY, tlPY$Tag.No, tlPY$Trap.2)

trap2PY <- trap2PY[, , dimnames(trap2PY)[[3]]!='N/A']
tt <- unique(c(dimnames(trap1PY)[[3]], dimnames(trap2PY)[[3]]))

appd <- array(0, replace(dim(trap1PY), 3, length(tt)-dim(trap1PY)[3]),
              dimnames=list(dimnames(trap1PY)[[1]], dimnames(trap1PY)[[2]],
                            tt[!(tt %in% dimnames(trap1PY)[[3]])]))
trap1PY <- abind::abind(trap1PY, appd, along=3)

appd <- array(0, replace(dim(trap2PY), 3, length(tt)-dim(trap2PY)[3]),
              dimnames=list(dimnames(trap2PY)[[1]], dimnames(trap2PY)[[2]],
                            tt[!(tt %in% dimnames(trap2PY)[[3]])]))
trap2PY <- abind::abind(trap2PY, appd, along=3)

mammals <- allMammals[allMammals %in% dimnames(trap1PY)[[3]]]
trap1PY <- apply(trap1PY[,, mammals], 1:2, sum)
trap2PY <- apply(trap2PY[,, mammals], 1:2, sum)

catchPY <- trap1PY + trap2PY

# Combine catch and catchPY to get 12 months data in order
catch <- t(catch)
catchPY <- t(catchPY)
catch <- catch[, apply(catch, 2, function(x) length(x[x!=0 & !is.na(x)])!=0)]
catch12m <- cbind(catchPY[,-(1:ncol(catch))], catch)
```

```{r trapCoords}
load('TrapCoordinates.RData') # Waypoints (saved by TrapLocations.Rmd)

# Rename Tag.No to match Waypoints
trap <- row.names(catch12m)
trap[substring(trap, 1, 1)=='A'] <- sub('A', 'ALF', trap[substring(trap, 1, 1)=='A'])
trap[substring(trap, 1, 1)=='B'] <- sub('B', 'X', trap[substring(trap, 1, 1)=='B']) # dummy substitution
trap[substring(trap, 1, 1)=='E'] <- sub('E', 'EE', trap[substring(trap, 1, 1)=='E'])
trap[substring(trap, 1, 1)=='F'] <- sub('F', 'FF', trap[substring(trap, 1, 1)=='F'])
trap[substring(trap, 1, 1)=='K'] <- sub('K', 'AK', trap[substring(trap, 1, 1)=='K'])
trap[substring(trap, 1, 1)=='M'] <- sub('M', 'MBL', trap[substring(trap, 1, 1)=='M'])
trap[substring(trap, 1, 1)=='X'] <- sub('X', 'MRB', trap[substring(trap, 1, 1)=='X']) # actual substitution
trap[substring(trap, 1, 1)=='P'] <- sub('P', 'PS', trap[substring(trap, 1, 1)=='P'])
trap[substring(trap, 1, 1)=='R'] <- sub('RS', 'RDS', trap[substring(trap, 1, 1)=='R'])
trap[substring(trap, 1, 1)=='S'] <- sub('SH', 'SHY', trap[substring(trap, 1, 1)=='S'])
trap[substring(trap, 1, 1)=='T'] <- sub('T', 'LDT', trap[substring(trap, 1, 1)=='T'])
row.names(catch12m) <- trap

# Merge trapLoc with catch12m
catch12m <- merge(trapLoc, catch12m, by.x='Trap', by.y='row.names')

cumCatch <- catch12m
cumCatch[, ncol(cumCatch):4] <- t(apply(cumCatch[, ncol(cumCatch):4], 1, cumsum))

lineGrps <- vector('list', 3)
lineGrps[[1]] <- c('ALF','PS','LD','LDT','RDS')
lineGrps[[2]] <- c('SHY','CG')
lineGrps[[3]] <- c('CG','EE','MBL','MRB','AK','FF')

par(mar=rep(0, 4))
ttCols <- viridisLite::inferno(ncol(catch12m)-3)

for (lns in 1:length(lineGrps))
{  
  ttLines <- catch12m[gsub('[[:digit:]]', '', catch12m$Trap) %in% lineGrps[[lns]],]
  ttCum <- cumCatch[gsub('[[:digit:]]', '', cumCatch$Trap) %in% lineGrps[[lns]],]
  with(ttLines, plot(E, S, cex=0.4, col='grey50', axes=FALSE, xlab='', ylab=''))
  for (i in 4:ncol(catch12m))
  {  
    # points(ttLines[ttLines[,i]!=0, c('E', 'S')], pch=16, col=paste0('grey', seq(96, 8, -8)[i-3]),
    points(ttLines[ttLines[,i]!=0, c('E', 'S')], pch=16, col=ttCols[ncol(catch12m)+1-i],
           cex=ttCum[ttLines[,i]!=0, i]/2)
  }
}
# To do:
#   Add key
#   Ensure aspect ratio is correct
#   Add line labels (maybe) - perhaps colour coded line joining the traps (before or after points?)
#   Add actual map (maybe)
#   Write report around it
```

