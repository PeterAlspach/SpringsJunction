---
title: "Maruia Trap-lines: Monthly Summary"
author: "Peter Alspach"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    pdf_document:
  # html_document:
  # html_notebook:
    theme: spacelab
    toc: yes
    toc_depth: 5
    # toc_float: yes
    # code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, cache=TRUE, error=TRUE)
library(kableExtra)
```
## Introduction

```{r readData, echo=FALSE}
# Set the working directory and read the data
setwd('~/GitHub/SpringsJunction/TrapLines')
tl <- read.csv('traplines.csv', header=TRUE, sep=',', stringsAsFactors=FALSE)

# Rename traps with only a single digit 'd' to '0d'
relNo <- tl[grep('[[:upper:]][[:digit:]]{1}$', tl$Tag.No), 'Tag.No']
relNo <- paste0(substring(relNo, 1, nchar(relNo)-1), '0', substring(relNo, nchar(relNo)))
tl[grep('[[:upper:]][[:digit:]]{1}$', tl$Tag.No), 'Tag.No'] <- relNo

# Remove time from date stamp
tl$Date.Checked <- substring(tl$Date.Checked, 1, 10)
tl$jDay <- julian.Date(as.Date(tl$Date.Checked), origin=as.Date('2017-12-31'))

# # Line name and code
# ttTab <- table(tl$Line, gsub('([[:upper:]]+)([[:digit:]]+)', '\\1', tl$Tag.No))
# apply(ttTab, 1, function(x) dimnames(ttTab)[[2]][x!=0])
```

```{r getReady, echo=FALSE}
# Set the cut-off dates for the monthly intervals
lastDate <- sort(tl$Date.Checked, decreasing=TRUE)[1]
yr <- as.integer(substring(lastDate, 1, 4))
mth <- as.integer(substring(lastDate, 6, 7))
cutDays <- paste(yr, c(paste0('0', 1:9), 10:12), '15', sep='-') # cut at the middle of the month 
cutDays <- julian.Date(as.Date(cutDays), origin=as.Date(paste0(yr-1, '-12-31')))
obsMth <- cut(tl$jDay, c(cutDays, 365+15+floor((4.001-yr%%4)/4)), 
              labels=c('J-F', 'F-M', 'M-A','A-M', 'M-J', 'J-J',
                       'J-A', 'A-S', 'S-O', 'O-N', 'N-D', 'D-J'))

# Set the standard trap status of interest
stdStat <- c('Sprung and Empty','Rat','Stoat','Weasel') # standard trap status
```

The following tables give a summary of the catches from the `r length(unique(tl$Tag.No))` traps on the `r length(unique(tl$Line))` trap-lines at Maruia.  The intention is to check the traps monthly around the change of the month, hence monthly summaries are aggregated from the 16^th^ of one month to the 15^th^ of the next (and labelled with the first letter of the two months)^[There were no records for the first half of January 2018.].

The summary is for the most recent monthly interval (`r paste(month.name[(mth-1):mth], collapse='-')`) in `r yr` and also the entire year-to-date.

## The most recent monthly interval

```{r currMth, echo=FALSE}
# Subset tl to the data for the current month only
currMth <- tl[obsMth==levels(obsMth)[mth-1],]

# First tabulate the number of pests caught
trap1 <- table(currMth$Line, currMth$Trap.1)
trap2 <- table(currMth$Line, currMth$Trap.2)
trap2 <- trap2[, colnames(trap2)!='N/A']
tt <- unique(c(colnames(trap1), colnames(trap2)))

trap1 <- cbind(trap1, matrix(0, nrow(trap1), sum(!(tt %in% colnames(trap1))),
                             dimnames=list(dimnames(trap1)[[1]], tt[!(tt %in% colnames(trap1))])))
trap2 <- cbind(trap2, matrix(0, nrow(trap2), sum(!(tt %in% colnames(trap2))),
                             dimnames=list(dimnames(trap2)[[1]], tt[!(tt %in% colnames(trap2))])))
catch <- trap1[, tt] + trap2[, tt]
catch <- catch[, match(c(stdStat, 'Cat','Ferret','Mouse','Rabbit'), colnames(catch))]
catch <- cbind(catch[, 1:length(stdStat)],
               Other=apply(catch[, -(1:length(stdStat))], 1, sum, na.rm=TRUE))
catch <- cbind(catch, Total=apply(catch[, -1], 1, sum, na.rm=TRUE))

# Next add in the number of traps per line (irrespective of whether some are missing)
nTrap <- table(tl$Line, gsub('([[:upper:]]+)([[:digit:]]+)', '\\2', tl$Tag.No))
catch <- merge(apply(nTrap, 1, function(x) length(x[x!=0])), catch, by='row.names', all=TRUE)
colnames(catch)[2:3] <- c('nTrap','Sprung')

rownames(catch) <- catch$Row.names
catch <- catch[,-1]
catch <- rbind(catch, apply(catch, 2, sum, na.rm=TRUE))
rownames(catch)[nrow(catch)] <- 'TOTAL'

# Add proportions based on total number of traps per line (including missing traps)
catch <- cbind(catch, round(apply(catch[,-1], 2, function(x) 100*x/catch[,1]), 1))
```

The table (below) summarises the number of pests caught in the most recent monthly interval for each line.  The first column is the number of traps^[In some cases traps may be missing or not found at checking, but this is disregarded in this summary], followed by the number which were sprung but empty.  The remaining columns (in blue) give the numbers of rats, stoats, weasels, other mammals (e.g., cats, ferrets, rabbits) and the total mammals.  

```{r currMthN, echo=FALSE}
kable(catch[, 1:(length(stdStat)+3)]) %>%
  kable_styling(full_width=FALSE) %>%
  column_spec(length(stdStat)+4, bold=TRUE) %>%
  column_spec(3, border_left=TRUE) %>%
  column_spec(4:8, color='blue') %>%
  row_spec(nrow(catch), bold = T, background = "#e5e5e5")
```

The next table is similar, except that the numbers are expressed as percentages of the total number of traps on the line.

```{r currMthPC, echo=FALSE}
kable(catch[, c(1, ((length(stdStat)+4):ncol(catch)))]) %>%
  kable_styling(full_width=FALSE) %>%
  column_spec(length(stdStat)+4, bold=TRUE) %>%
  column_spec(3, border_left=TRUE) %>%
  column_spec(4:8, color='blue') %>%
  row_spec(nrow(catch), bold = T, background = "#e5e5e5")
```

## The year to date

### Mammals caught by line

```{r yrToDate, echo=FALSE}
# First tabulate the number of pests caught
trap1 <- table(tl$Line, tl$Trap.1)
trap2 <- table(tl$Line, tl$Trap.2)
trap2 <- trap2[, colnames(trap2)!='N/A']
tt <- unique(c(colnames(trap1), colnames(trap2)))

trap1 <- cbind(trap1, matrix(0, nrow(trap1), sum(!(tt %in% colnames(trap1))),
                             dimnames=list(dimnames(trap1)[[1]], tt[!(tt %in% colnames(trap1))])))
trap2 <- cbind(trap2, matrix(0, nrow(trap2), sum(!(tt %in% colnames(trap2))),
                             dimnames=list(dimnames(trap2)[[1]], tt[!(tt %in% colnames(trap2))])))
catch <- trap1[, tt] + trap2[, tt]
catch <- catch[, match(c(stdStat, 'Cat','Ferret','Mouse','Rabbit'), colnames(catch))]
catch <- cbind(catch[, 1:length(stdStat)],
               Other=apply(catch[, -(1:length(stdStat))], 1, sum, na.rm=TRUE))
catch <- cbind(catch, Total=apply(catch[, -1], 1, sum, na.rm=TRUE))

# Next add in the number of traps per line (irrespective of whether some are missing)
nTrap <- table(tl$Line, gsub('([[:upper:]]+)([[:digit:]]+)', '\\2', tl$Tag.No))
catch <- merge(apply(nTrap, 1, function(x) length(x[x!=0])), catch, by='row.names', all=TRUE)
colnames(catch)[2:3] <- c('nTrap','Sprung')

rownames(catch) <- catch$Row.names
catch <- catch[,-1]
catch <- rbind(catch, apply(catch, 2, sum, na.rm=TRUE))
rownames(catch)[nrow(catch)] <- 'TOTAL'

# Add numbers caught per trap per month (x 100)
catch <- cbind(catch, round(apply(catch[,-1], 2, function(x) 100*x/(catch[,1]*(mth-1))), 1))
```

The first table (below) summarises the number of pests caught in the year to date for each line.  The first column is the number of traps, followed by the number which were sprung but empty.  The remaining columns (in blue) give the numbers of rats, stoats, weasels, other mammals (e.g., cats, ferrets, rabbits) and the total mammals.  

```{r yrToDateN, echo=FALSE}
kable(catch[, 1:(length(stdStat)+3)]) %>%
  kable_styling(full_width=FALSE) %>%
  column_spec(length(stdStat)+4, bold=TRUE) %>%
  column_spec(3, border_left=TRUE) %>%
  column_spec(4:8, color='blue') %>%
  row_spec(nrow(catch), bold = T, background = "#e5e5e5")
```

Next, the data are presented as numbers caught per trap per month (x 100) for each line.  This is analogous to the second table in the current month section which gave the percentages.

```{r yrToDatePC, echo=FALSE}
kable(catch[, c(1, ((length(stdStat)+4):ncol(catch)))]) %>%
  kable_styling(full_width=FALSE) %>%
  column_spec(length(stdStat)+4, bold=TRUE) %>%
  column_spec(3, border_left=TRUE) %>%
  column_spec(4:8, color='blue') %>%
  row_spec(nrow(catch), bold = T, background = "#e5e5e5")
```

### Mammals caught by month

### Catch by month for each line
